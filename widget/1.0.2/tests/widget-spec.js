define(function(e){var t=e("../src/widget"),n=e("../src/daparser"),r=e("$");describe("Widget",function(){test("initAttrs",function(){var e=r('<div id="a"></div>').appendTo(document.body),n=t.extend({attrs:{element:"#default",foo:"foo",template:"<span></span>"},model:{title:"default title",content:"default content"}}),i=new n({element:"#a",bar:"bar",template:"<a></a>",model:{title:"title a"}});expect(i.get("bar")).toBe("bar"),expect(i.get("foo")).toBe("foo"),expect(i.get("template")).toBe("<a></a>"),expect(i.model.title).toBe("title a"),expect(i.model.content).toBe("default content"),expect(i.element[0].id).toBe("a"),e.remove()}),test("parseElement",function(){var e=r('<div id="a"></div>').appendTo(document.body),n=new t;expect(n.element[0].tagName).toBe("DIV"),n=new t({element:"#a"}),expect(n.element[0].id).toBe("a"),n=new t({element:document.getElementById("a")}),expect(n.element[0].id).toBe("a"),n=new t({element:r("#a")}),expect(n.element[0].id).toBe("a");try{new t({element:"#b"}),expect("应该抛错").toBe("没有抛错")}catch(i){}n=new t({element:"#a",template:"<span></span>"}),expect(n.element[0].tagName).toBe("DIV"),n=new t({template:"<span></span>"}),expect(n.element[0].tagName).toBe("SPAN"),e.remove()}),test("parse data attrs",function(){var e=new t;document.body.setAttribute("data-api","off");var r=n.parseElement(e.element);delete r.widgetCid,expect(r).toEqual({})}),test("delegateEvents / undelegateEvents",function(){function e(){n++}var n=0,r={},i={},s=t.extend({events:{"click p":"fn1","click li":"fn2","mouseenter span":"fn3"},fn1:function(){n++},fn2:function(){n++},fn3:function(e){r=e,i=this}}),o=(new s({template:"<div><p></p><ul><li></li></ul><span></span></div>"})).render();o.$("p").trigger("click"),expect(n).toBe(1),n=0,o.$("li").trigger("click"),expect(n).toBe(1),n=0,o.element.trigger("click"),expect(n).toBe(0),n=0,o.$("span").trigger("mouseenter"),expect(r.currentTarget.tagName).toBe("SPAN"),expect(i).toBe(o),o.delegateEvents({"click p":"fn2","click span":function(){n++}}),o.delegateEvents("click li",e),n=0,o.$("li").trigger("click"),expect(n).toBe(2),n=0,o.$("p").trigger("click"),expect(n).toBe(2),n=0,o.$("span").trigger("click"),expect(n).toBe(1),n=0,o.undelegateEvents("click p"),o.$("p").trigger("click"),expect(n).toBe(0),n=0,o.undelegateEvents(),o.$("li").trigger("click"),o.$("p").trigger("click"),expect(n).toBe(0)}),test("events hash can be a function",function(){var e=0,n=t.extend({events:function(){return{"click h3":"incr","click p":"incr"}},incr:function(){e++}}),r=(new n({template:"<div><h3></h3><p></p></div>"})).render();r.$("h3").trigger("click"),expect(e).toBe(1),e=0,r.$("p").trigger("click"),expect(e).toBe(1)}),test("the default event target is `this.element`",function(){var e=0,n=t.extend({events:function(){return{click:"incr"}},incr:function(){e++}}),r=(new n).render();r.element.trigger("click"),expect(e).toBe(1)}),test("parentNode is a document fragment",function(){var e="test"+new Date,n=r('<div id="'+e+'"></div><div></div>');(new t({element:n.eq(0),parentNode:document.body})).render(),expect(document.getElementById(e).nodeType).toBe(1)}),test("template in delegate-events",function(){var e=0,n=t.extend({attrs:{buttons:"button"},events:{"click p":"incr","click {{attrs.buttons}}":"incr"},incr:function(){e++}}),i=(new n({template:'<div><header>x</header><button>x</button><p>x</p><div id="ttt"></div></div>'})).render();i.$("p").trigger("click"),expect(e).toBe(1),e=0,r(i.get("buttons")).trigger("click"),expect(e).toBe(1)}),test("delegate events inherited from ancestors",function(){function e(){n++}var n=0,r=t.extend({events:{"click p":e}}),i=r.extend({events:{"click div":e}}),s=(new i({template:"<section><p></p><div></div><span></span></section>",events:{"click span":e}})).render();n=0,s.$("p").trigger("click"),expect(n).toBe(1),n=0,s.$("div").trigger("click"),expect(n).toBe(1),n=0,s.$("span").trigger("click"),expect(n).toBe(1)}),test("ignore null element during delegating events",function(){function e(){n++}var n=0,r=t.extend({attrs:{cancelButton:null},events:{"click {{attrs.cancelButton}}":"incr"}});new r}),test("#76: set default attrs automatically",function(){var e=t.extend({attrs:{a:1,b:1},_onRenderA:function(e){this.a=e}}),n=new e({b:2});expect(n.get("a")).toBe(1),expect(n.get("b")).toBe(2),expect(n.a).toBeUndefined(),n.render(),expect(n.a).toBe(1)}),test("set attribute before render method",function(){var e=[],n=[],r=t.extend({attrs:{a:1},_onRenderA:function(t,r){e.push(t),n.push(r)}}),i=new r({a:2});i.set("a",3),i.render(),expect(e.join()).toBe("3"),expect(n.join()).toBe("")}),test("default values in attrs",function(){function e(){n++}var n=0,r=t.extend({attrs:{bool:!1,str:"",str2:"x",obj:{},arr:[],fn:null,obj2:null,fn2:undefined,fn3:function(){}},_onRenderBool:e,_onRenderStr:e,_onRenderStr2:e,_onRenderObj:e,_onRenderObj2:e,_onRenderArr:e,_onRenderFn:e,_onRenderFn2:e,_onRenderFn3:e}),i=new r;expect(n).toBe(0),i.render(),expect(n).toBe(3),n=0;var s=new r({str2:""});expect(n).toBe(0),s.render(),expect(n).toBe(2)}),test("call render() after first render",function(){function e(){n++}var n=0,r=t.extend({attrs:{a:1},_onRenderA:e}),i=new r;i.render(),expect(n).toBe(1),i.render(),expect(n).toBe(1)}),test("statics white list",function(){var e=t.extend();expect(typeof e.autoRender).toBe("function"),expect(typeof e.autoRenderAll).toBe("undefined")}),test("data attr api",function(){var e=r('<div id="data-attr-api-test" data-a=1 data-b="b" data-arr="[1,2,3]" data-c="true" data-d=\'{"num": 1, "str": "s", "bool": true}\'></div>').appendTo(document.body),n=new t({element:"#data-attr-api-test",b:"b2"});expect(n.get("a")).toBe(1),expect(n.get("b")).toBe("b2"),expect(n.get("c")).toBe(!0),expect(n.get("d").num).toBe(1),expect(n.get("d").str).toBe("s"),expect(n.get("d").bool).toBe(!0),expect(n.get("arr")).toEqual([1,2,3])}),test("onXx setter in attrs",function(){function e(){n++}var n=0,r={a:e},i=t.extend({attrs:{onXx:function(){n++},onYy:{setter:function(e){return r[e]}}},test:function(){this.trigger("xx"),this.trigger("yy")}}),s=new i({onYy:"a"});s.test(),expect(n).toBe(2)}),test("inherited attrs",function(){var e=t.extend({attrs:{a:"",b:null}}),n=e.extend({attrs:{a:"1"}}),r=n.extend({attrs:{a:"2",b:"b"}}),i=new r;expect(i.get("a")).toBe("2"),expect(i.get("b")).toBe("b")}),test("#3: parentNode is a jQuery object",function(){var e=new t({parentNode:r("#test1")});e.render(),expect(r("#test1 div").html()).toBe("")}),test("override object in prototype",function(){var e=t.extend({o:{p1:"1"}}),n=e.extend({o:{p2:"2"}}),r=new n;expect(r.o.p1).toBe(undefined),expect(r.o.p2).toBe("2")}),test("mix events object in prototype",function(){var e=t.extend({events:{p1:"1"}}),n=e.extend({events:{p2:"2"}}),r=new n;expect(r.events.p1).toBe("1"),expect(r.events.p2).toBe("2")})});var i=Object.keys;i||(i=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t})});